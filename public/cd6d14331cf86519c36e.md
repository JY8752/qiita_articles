---
title: Kotlin + JOOQ + Spring + Flyway + Testcontainersã§æ›¸ãDBå‡¦ç†
tags:
  - Kotlin
  - Flyway
  - SpringBoot
  - jOOQ
  - AdventCalendar2022
private: false
updated_at: '2022-12-15T14:39:43+09:00'
id: cd6d14331cf86519c36e
organization_url_name: null
---
ã“ã®è¨˜äº‹ã¯ç­†è€…ã®[ã‚½ãƒ­ Advent Calendar 2022](https://qiita.com/advent-calendar/2022/panda) 7æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚

å‰å›ã¾ã§ã¯Spockã«ã¤ã„ã¦ã®è¨˜äº‹ã‚’æ›¸ã„ã¦ãã¾ã—ãŸãŒä»Šå›ã¯ORMã§ã‚ã‚‹JOOQã‚’Kotlinã§ä½¿ç”¨ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¦ã„ãã¾ã™ã€‚ã¾ãŸã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«Flyway, ãƒ†ã‚¹ãƒˆã«Testcontainersã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

æœ¬è¨˜äº‹ã§ä½œæˆã—ãŸã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰

https://github.com/JY8752/jooq-demo

# JOOQã¨ã¯
JVMè¨€èªã«ãŠã„ã¦ORMã®é¸æŠè‚¢ã¯å¤šãã‚ã‚Šã€JOOQã‚‚ãã®ã†ã¡ã®ä¸€ã¤ã§ã‚ã‚‹ã€‚JOOQã‚’ä½¿ç”¨ã™ã‚‹ãƒ¡ãƒªãƒƒãƒˆã¨ã—ã¦ä»¥ä¸‹ã®ã‚ˆã†ãªç‰¹å¾´ãŒã‚ã‚‹ã€‚
- SQLãƒ©ã‚¤ã‚¯ã«å‡¦ç†ãŒã‹ã‘ã‚‹ã€‚
- è¤‡é›‘ãªSQLãŒæ›¸ãã‚„ã™ã„ã€‚
- å‹å®‰å…¨ã€‚
- DBã‹ã‚‰ã‚³ãƒ¼ãƒ‰ã‚’è‡ªå‹•ç”Ÿæˆã§ãã‚‹ã€‚

https://www.jooq.org/

# Spring
Spring Initializerã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹ã€‚JOOQã¯ä¾å­˜é–¢ä¿‚ãŒç”¨æ„ã•ã‚Œã¦ã„ã‚‹ãŸã‚JOOQã¨MySQLãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã®ä¾å­˜é–¢ä¿‚ã‚’é¸æŠã—ã¦ãŠãã€‚ä»Šå›ã¯Testcontainersã‚‚ä½¿ç”¨ã™ã‚‹ãŸã‚ä¾å­˜é–¢ä¿‚ã«è¿½åŠ ã—ã¦ãŠãã€‚build.gradle.ktsã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚‹ã€‚

```kotlin:build.gradle.kts
import org.jetbrains.kotlin.gradle.tasks.KotlinCompile

plugins {
    id("org.springframework.boot") version "2.7.5"
    id("io.spring.dependency-management") version "1.0.15.RELEASE"
    kotlin("jvm") version "1.6.21"
    kotlin("plugin.spring") version "1.6.21"
}

group = "com.example"
version = "0.0.1-SNAPSHOT"
java.sourceCompatibility = JavaVersion.VERSION_17

repositories {
    mavenCentral()
}

extra["testcontainersVersion"] = "1.17.4"

dependencies {
    implementation("org.springframework.boot:spring-boot-starter-jooq")
    implementation("org.springframework.boot:spring-boot-starter-web")
    implementation("com.fasterxml.jackson.module:jackson-module-kotlin")
    implementation("org.jetbrains.kotlin:kotlin-reflect")
    implementation("org.jetbrains.kotlin:kotlin-stdlib-jdk8")
    runtimeOnly("com.mysql:mysql-connector-j")
    testImplementation("org.springframework.boot:spring-boot-starter-test")

    // testcontainers
    testImplementation("org.testcontainers:junit-jupiter")
    testImplementation("org.testcontainers:mysql")
}

dependencyManagement {
    imports {
        mavenBom("org.testcontainers:testcontainers-bom:${property("testcontainersVersion")}")
    }
}

tasks.withType<KotlinCompile> {
    kotlinOptions {
        freeCompilerArgs = listOf("-Xjsr305=strict")
        jvmTarget = "17"
    }
}

tasks.withType<Test> {
    useJUnitPlatform()
}
```

Flywayã¨JOOQã‚’çµ„ã¿åˆã‚ã›ã¦ä½¿ã†å ´åˆã€Flywayã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¨JOOQã®ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚¿ã‚¹ã‚¯ãŒã†ã¾ãå™›ã¿åˆã‚ãªã„ã®ã§Flywayã¯æ‰‹å‹•ã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ã€‚ã¾ãŸã€JOOQã®ã‚³ãƒ¼ãƒ‰ç”Ÿæˆç”¨ã®ã‚¿ã‚¹ã‚¯å®šç¾©ã‚‚è¡Œã†ã€‚ãƒ†ã‚¹ãƒˆã«Kotestã‚’è¿½åŠ ã—ã¦ã€æœ€çµ‚çš„ãªbuild.gradle.ktsã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚‹ã€‚

```diff_kotlin:build.gradle.kts
import org.jetbrains.kotlin.gradle.tasks.KotlinCompile

plugins {
    id("org.springframework.boot") version "2.7.5"
    id("io.spring.dependency-management") version "1.0.15.RELEASE"
+    id("nu.studer.jooq") version "8.0" // ã“ã‚Œã‚’è¿½åŠ 
+    id("org.flywaydb.flyway") version "8.0.1" //ã“ã‚Œã‚‚è¿½åŠ 
    kotlin("jvm") version "1.6.21"
    kotlin("plugin.spring") version "1.6.21"
}

group = "com.example"
version = "0.0.1-SNAPSHOT"
java.sourceCompatibility = JavaVersion.VERSION_17

repositories {
    mavenCentral()
}

extra["testcontainersVersion"] = "1.17.4"

dependencies {
    implementation("org.springframework.boot:spring-boot-starter-jooq")
    implementation("org.springframework.boot:spring-boot-starter-web")
    implementation("com.fasterxml.jackson.module:jackson-module-kotlin")
    implementation("org.jetbrains.kotlin:kotlin-reflect")
    implementation("org.jetbrains.kotlin:kotlin-stdlib-jdk8")
    runtimeOnly("com.mysql:mysql-connector-j")
    testImplementation("org.springframework.boot:spring-boot-starter-test")

    // testcontainers
    testImplementation("org.testcontainers:junit-jupiter")
    testImplementation("org.testcontainers:mysql")

    // flyway
+    implementation("org.flywaydb:flyway-mysql")

    // kotest
+    val kotest_version = "5.5.4"
+    testImplementation("io.kotest:kotest-runner-junit5-jvm:$kotest_version")
+    testImplementation("io.kotest.extensions:kotest-extensions-spring:1.1.2")

    // jooq
+    jooqGenerator("com.mysql:mysql-connector-j")
+    jooqGenerator("jakarta.xml.bind:jakarta.xml.bind-api:4.0.0")
}

dependencyManagement {
    imports {
        mavenBom("org.testcontainers:testcontainers-bom:${property("testcontainersVersion")}")
    }
}

tasks.withType<KotlinCompile> {
    kotlinOptions {
        freeCompilerArgs = listOf("-Xjsr305=strict")
        jvmTarget = "17"
    }
}

tasks.withType<Test> {
    useJUnitPlatform()
}

+ jooq {
+    configurations {
+        create("main") {
+            jooqConfiguration.apply {
+                jdbc.apply {
+                    url = "jdbc:mysql://localhost:3306/library?enabledTLSProtocols=TLSv1.2"
+                    user = "root"
+                    password = "root"
+                }
+                generator.apply {
+                    name = "org.jooq.codegen.KotlinGenerator"
+                    database.apply {
+                        name = "org.jooq.meta.mysql.MySQLDatabase"
+                        inputSchema = "library"
+                        excludes = "flyway_schema_history"
+                    }
+                    generate.apply {
+                        isDeprecated = false
+                        isTables = true
+                    }
+                    target.apply {
+                        packageName = "com.example.ktknowledgeTodo.infra.jooq"
+                        directory = "$buildDir/generated/source/jooq/main"
+                    }
+                }
+            }
+        }
+    }
+ }

+ flyway {
+    url = "jdbc:mysql://localhost:3306/library?enabledTLSProtocols=TLSv1.2"
+    user = "root"
+    password = "root"
+ }
```
æ‰‹æŠœãã§ã€€DBæƒ…å ±ã‚’ç›´æ›¸ãã—ã¦ã„ã¾ã™ãŒã€å®Ÿéš›ã«ã¯ç’°å¢ƒå¤‰æ•°ãªã©ã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚JOOQã‚¿ã‚¹ã‚¯ã®è¨­å®šã¯ä»¥ä¸‹ã®è¨˜äº‹ã‚’ã»ã¼ãã®ã¾ã¾ä½¿ç”¨ã•ã›ã¦ã„ãŸã ã„ã¦ã¾ã™ğŸ™‡â€â™‚ï¸

https://zenn.dev/yamachoo/articles/spring-jooq-flyway-mysql

# DB
DBã¯dockerã§æº–å‚™ã—ã¾ã™ã€‚

```yml:docker-compose.yml
version: '3'

services:
  # MySQL
  db:
    image: mysql:latest
    container_name: mysql_container
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: library
      TZ: 'Asia/Tokyo'
    command: mysqld --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    volumes:
      - ./docker/db/data:/var/lib/mysql
      - ./docker/db/my.cnf:/etc/mysql/conf.d/my.cnf
      - ./docker/db/sql:/docker-entrypoint-initdb.d
    ports:
      - "3306:3306"
```

ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®SQLãƒ•ã‚¡ã‚¤ãƒ«ã¯ä»¥ä¸‹ã€‚

```sql:V1.0.0__create_table.sql
CREATE DATABASE IF NOT EXISTS `library`;

USE `library`;

CREATE TABLE IF NOT EXISTS `author` (
  `id` int NOT NULL AUTO_INCREMENT,
  `first_name` varchar(255) DEFAULT NULL,
  `last_name` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`id`)
);
```

dokcerã‚’èµ·å‹•
```
docker-comose up -d
```

ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
```
./gradlew flywayMigrate
```

JOOQã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
```
./gradlew generateJooq
```

buildé…ä¸‹ã«ã‚³ãƒ¼ãƒ‰ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚Œã°å®Œäº†ã§ã™ã€‚

# å®Ÿè£…
ä»¥ä¸‹ã®ã‚ˆã†ãªAutherãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ‰±ã†ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãªã©ã‚’å®Ÿè£…ã—ã¦ã„ãã€‚
![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/551753/b84e4871-8e54-933c-1823-4360c7297946.png)

ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã®å®šç¾©
```kotlin:AuthorRepository
package com.example.jooqdemo.domain.repository

import com.example.jooqdemo.domain.model.Author

interface AuthorRepository {
    fun findById(id: Int): Author?
    fun findAll(): List<Author>
    fun save(firstName: String, lastName: String): Author
    fun deleteAll()
}
```

ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã®å®Ÿè£…ã‚¯ãƒ©ã‚¹ã€‚ç‰¹ç­†ã™ã‚‹ã“ã¨ã‚‚ç‰¹ã«ãªã„ãŒDSLContextã‚’DIã—ã¦SQLã¿ãŸã„ã«å‡¦ç†ã‚’çµ„ã¿ç«‹ã¦ã‚‹ã€‚æœ¬å½“ã«SQLã®ã‚ˆã†ã«æ›¸ã‘ã‚‹ã€‚æœ€çµ‚çš„ãªæˆ»ã‚Šå€¤ãŒRecordã‚¯ãƒ©ã‚¹ã«ãªã‚‹ã®ã§Modelã‚¯ãƒ©ã‚¹ã‚’ç”¨æ„
ã—ã¦å¤‰æ›ã—ã¦ã„ã‚‹ã€‚

```kotlin:AuthoerRepositoryImpl
package com.example.jooqdemo.infrastructure.repository

import com.example.jooqdemo.domain.model.Author
import com.example.jooqdemo.domain.repository.AuthorRepository
import com.example.ktknowledgeTodo.infra.jooq.tables.Author.Companion.AUTHOR
import org.jooq.DSLContext
import org.jooq.Record
import org.springframework.stereotype.Repository

@Repository
class AuthorRepositoryImpl(
    private val dslContext: DSLContext
) : AuthorRepository {
    override fun findById(id: Int): Author? {
        return this.dslContext.select()
            .from(AUTHOR)
            .where(AUTHOR.ID.eq(id))
            .fetchOne()?.let { toModel(it) }
    }

    override fun findAll(): List<Author> {
        return this.dslContext.select()
            .from(AUTHOR)
            .fetch().map { toModel(it) }
    }

    override fun save(firstName: String, lastName: String): Author {
        val record = this.dslContext.newRecord(AUTHOR).also {
            it.firstName = firstName
            it.lastName = lastName
            it.store()
        }
        return Author(record.id!!, record.firstName!!, record.lastName!!)
    }

    override fun deleteAll() {
        this.dslContext.deleteFrom(AUTHOR).execute()
    }

    private fun toModel(record: Record) = Author(
        record.getValue(AUTHOR.ID)!!,
        record.getValue(AUTHOR.FIRST_NAME)!!,
        record.getValue(AUTHOR.LAST_NAME)!!
    )
}

```

```kotlin:Authoer
package com.example.jooqdemo.domain.model

data class Author(val id: Int, val firstName: String, val lastName: String)
```

# ãƒ†ã‚¹ãƒˆ
ãƒ†ã‚¹ãƒˆã«ã¯Kotestã¨Testcontainersã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ã¾ãšã€æº–å‚™ã¨ã—ã¦Kotestã§@SpringBootTestã‚’ä½¿ç”¨ã™ã‚‹ã®ã«Extentionã‚’ç™»éŒ²ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ä»¥ä¸‹ã®ã‚ˆã†ãªConfigã‚¯ãƒ©ã‚¹ã‚’ç”¨æ„ã™ã‚‹ã€‚

```kotlin:ProjectConfig
package com.example.jooqdemo

import io.kotest.core.config.AbstractProjectConfig
import io.kotest.extensions.spring.SpringExtension

class ProjectConfig : AbstractProjectConfig() {
    override fun extensions() = listOf(SpringExtension)
}
```

Testcontainersã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€å¤§é‡ã®ãƒ­ã‚°ãŒå‡ºã‚‹ã®ãŒå«Œãªã®ã§ä»¥ä¸‹ã®logbackãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®ã—ã¦æ­¢ã‚ã¦ãŠãã€‚

```xml: logback-test.xml
<configuration>
    <appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d{HH:mm:ss.SSS} [%thread] %-5level %logger - %msg%n</pattern>
        </encoder>
    </appender>

    <root level="info">
        <appender-ref ref="STDOUT"/>
    </root>

    <logger name="org.testcontainers" level="INFO"/>
    <logger name="com.github.dockerjava" level="WARN"/>
    <logger name="com.github.dockerjava.zerodep.shaded.org.apache.hc.client5.http.wire" level="OFF"/>
</configuration>
```

å®Ÿéš›ã®ãƒ†ã‚¹ãƒˆã¯ã“ã‚“ãªæ„Ÿã˜

```kotlin:AuthorRepositoryTest
package com.example.jooqdemo.domain

import com.example.jooqdemo.domain.repository.AuthorRepository
import io.kotest.core.spec.style.FunSpec
import io.kotest.matchers.shouldBe
import org.flywaydb.core.Flyway
import org.springframework.boot.test.context.SpringBootTest
import org.testcontainers.containers.MySQLContainer

@SpringBootTest
internal class AuthorRepositoryTest(
    private val authorRepository: AuthorRepository
) : FunSpec({
    beforeSpec {
        //èµ·å‹•ã—ãŸMYSQLã‚³ãƒ³ãƒ†ãƒŠã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹
        Flyway.configure()
            .dataSource(container.jdbcUrl, container.username, container.password)
            .load()
            .migrate()
    }
    //ãƒ†ã‚¹ãƒˆãŒçµ‚ã‚ã‚‹ãŸã³ã«å¾Œå‡¦ç†
    afterTest { authorRepository.deleteAll() }
    test("save and find") {
        val saved = authorRepository.save("first", "last")
        val find = authorRepository.findById(saved.id)
        saved shouldBe find
    }
    test("find count one") {
        authorRepository.save("first", "last")
        authorRepository.findAll().size shouldBe 1
    }
}) {
    companion object {
        //MySQLã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•
        val container = MySQLContainer("mysql:latest").apply {
            withDatabaseName("library")
            withUsername("root")
            withPassword("root")
            start()
        }
    }
}
```

ã“ã‚Œã§ãƒ†ã‚¹ãƒˆå‰ã«MySQLã‚³ãƒ³ãƒ†ãƒŠã®èµ·å‹•ã¨ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œã‚’ã—ãŸä¸Šã§å¥½ãã«ãƒ†ã‚¹ãƒˆãŒæ›¸ã‘ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚æ³¨æ„ç‚¹ã¨ã—ã¦èµ·å‹•ã—ãŸã‚³ãƒ³ãƒ†ãƒŠã¯ãƒ†ã‚¹ãƒˆé–“ã§å…±æœ‰ã—ã¦ä½¿ç”¨ã•ã‚Œã‚‹ãŸã‚ä½œæˆã—ãŸãƒ‡ãƒ¼ã‚¿ã®å¾Œå‡¦ç†ã‚’ã—ãªã„ã¨ä»–ã®ãƒ†ã‚¹ãƒˆã«å½±éŸ¿ãŒå‡ºã¦ã—ã¾ã„ã¾ã™ã€‚afterTestã§ä½œæˆã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ã„ã¾ã™ãŒã€ã“ã®å‡¦ç†ãŒãªã„ã¨2ã¤ç›®ã®ãƒ†ã‚¹ãƒˆã¯å¤±æ•—ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

# ã¾ã¨ã‚
ä»Šå›ã¯ä»¥ä¸‹ã®å†…å®¹ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚
- Kotlin + Springãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«JOOQã‚’å°å…¥ã™ã‚‹æ‰‹é †
- JOOQã¨åˆã‚ã›ã¦Flywayã‚’å°å…¥ã™ã‚‹æ‰‹é †
- Kotest, Testcontainersã‚’ä½¿ç”¨ã—ãŸDBå‡¦ç†ã®ãƒ†ã‚¹ãƒˆã«ã¤ã„ã¦


è§¦ã£ã¦ã¿ãŸæ„Ÿæƒ³ã¨ã—ã¦ã¯ã‹ãªã‚Šæ›¸ãå¿ƒåœ°ã¯ã‚ˆã‹ã£ãŸã§ã™ã€‚ç­†è€…ã¯Hibernateã®çµŒé¨“ãŒå¤šã‹ã£ãŸã§ã™ãŒæœ¬å½“ã«SQLã‚’æ›¸ãæ„Ÿã˜ã§ã‚³ãƒ¼ãƒ‰ãŒæ›¸ã‘ãŸã®ã§æ›¸ãæ–¹ã§æ‚©ã‚€ã“ã¨ã‚‚ã‚ã¾ã‚Šãªã‹ã£ãŸã§ã™ã€‚ã‚³ãƒ¼ãƒ‰ã‚’è‡ªå‹•ç”Ÿæˆã§ãã‚‹ã®ã‚‚å®Ÿè£…è² æ‹…ãŒæ¸›ã‚Šã„ã„ã¨æ€ã„ã¾ã™ã€‚

å°å…¥ã«ã‚ãŸã£ã¦Flywayã¨ã®å…¼ã­åˆã„ã¨ã„ã†ã‹ã‚³ãƒ¼ãƒ‰ã®è‡ªå‹•ç”Ÿæˆã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¨ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒå…¨ã¦è‡ªå‹•å®Ÿè¡Œã«ãªã£ã¦ã„ã‚‹ã¨ã†ã¾ãå‹•ã‹ãªã„ãªã©ã®éšœå£ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒä¸€å›å‹•ãã¨ã“ã‚ã¾ã§ã§ãã‚Œã°å•é¡Œãªã„ã¨æ€ã„ã¾ã™ã€‚ã¨ã‚Šã‚ãˆãšæ›¸ã„ã¦ã„ã¦æ¥½ã—ã„ã®ã§å€‹äººçš„ã«ã¯ã“ã‚Œã‹ã‚‰ã¯JOOQã‚’ä½¿ç”¨ã—ã¦ã„ã“ã†ã¨æ€ã„ã¾ã—ãŸï¼

ãœã²ã¿ãªã•ã‚“ã‚‚ãŠè©¦ã—ãã ã•ã„ï¼



